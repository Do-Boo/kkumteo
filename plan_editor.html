<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>새 계획서 작성 - 꿈터(KkumTeo)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 
    TinyMCE 에디터 설정 안내:
    1. https://www.tiny.cloud/ 에서 무료 API 키 발급 (이메일 등록 필요)
    2. 아래 URL의 'YOUR_API_KEY_HERE' 부분을 발급받은 키로 교체
    3. 개발 테스트 시에는 'no-api-key'로 사용 가능하나 기능 제한이 있음
    4. 실제 서비스에서는 반드시 유효한 API 키 사용 필요
    5. referrer 헤더 문제 해결: https://www.tiny.cloud/docs/tinymce/6/cloud-troubleshooting/#troubleshooting
    -->
    <script src="https://cdn.tiny.cloud/1/5whk9d2g1amydso47jmltvuyy2jak6ht6xoopt8levighzkr/tinymce/7/tinymce.min.js"
        referrerpolicy="origin-when-cross-origin"></script>
    <!-- 도메인 확인 문제 해결을 위한 메타 태그 -->
    <meta name="referrer" content="origin">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="common.css">
    <!-- 공통 스크립트 추가 -->
    <script src="includes/script.js"></script>
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f8f9fa;
            color: #374151;
        }

        :root {
            --pastel-green: #A7D7C5;
            --pastel-green-darker: #8EBFAC;
            --pastel-green-focus-shadow: rgba(167, 215, 197, 0.3);
            --form-input-border: #d1d5db;
            /* Tailwind gray-300 */
            --form-input-focus-border: var(--pastel-green);
            --form-button-bg: var(--pastel-green);
            --form-button-hover-bg: var(--pastel-green-darker);
            --form-button-secondary-bg: #e5e7eb;
            /* Tailwind gray-200 */
            --form-button-secondary-hover-bg: #d1d5db;
            /* Tailwind gray-300 */
            --form-button-secondary-text: #374151;
            /* Tailwind gray-700 */
        }

        .nav-link {
            position: relative;
            padding-bottom: 4px;
            color: #4b5563;
            transition: color 0.2s ease;
            text-decoration: none;
        }

        .nav-link:hover {
            color: var(--pastel-green-darker);
        }

        .nav-link::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: 0;
            width: 0;
            height: 2px;
            background-color: var(--pastel-green);
            transition: width 0.3s ease;
        }

        .nav-link:hover::after {
            width: 100%;
        }

        .header-search-input {
            border: 1px solid var(--form-input-border);
            border-radius: 0.375rem;
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
            width: 200px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .header-search-input:focus {
            outline: none;
            border-color: var(--form-input-focus-border);
            box-shadow: 0 0 0 2px var(--pastel-green-focus-shadow);
        }

        .form-container {
            max-width: 800px;
            margin: 2rem auto;
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
            padding: 2.5rem;
        }

        .form-title {
            font-size: 1.875rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 2rem;
            text-align: center;
        }

        .form-label {
            display: block;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 0.625rem 0.875rem;
            border: 1px solid var(--form-input-border);
            border-radius: 0.375rem;
            font-size: 1rem;
            color: #374151;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--form-input-focus-border);
            box-shadow: 0 0 0 2px var(--pastel-green-focus-shadow);
        }

        .form-textarea {
            min-height: 120px;
            /* 상세 설명 영역 높이 약간 줄임 (HTML 업로드 기능 추가로) */
            resize: vertical;
        }

        .form-input-group {
            margin-bottom: 1.5rem;
        }

        .form-file-input-wrapper {
            border: 2px dashed var(--form-input-border);
            border-radius: 0.375rem;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s ease;
        }

        .form-file-input-wrapper:hover {
            border-color: var(--form-input-focus-border);
        }

        .form-file-input-wrapper i {
            font-size: 2rem;
            color: #9ca3af;
            margin-bottom: 0.5rem;
        }

        .form-file-input-wrapper p {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .form-radio-group {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .form-radio-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 1rem;
        }

        .form-radio-label input[type="radio"] {
            margin-right: 0.5rem;
            accent-color: var(--pastel-green);
        }

        .form-actions {
            margin-top: 2.5rem;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        .form-button {
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-weight: 500;
            border-radius: 0.375rem;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .form-button-primary {
            background-color: var(--form-button-bg);
            color: white;
        }

        .form-button-primary:hover {
            background-color: var(--form-button-hover-bg);
        }

        .form-button-secondary {
            background-color: var(--form-button-secondary-bg);
            color: var(--form-button-secondary-text);
        }

        .form-button-secondary:hover {
            background-color: var(--form-button-secondary-hover-bg);
        }

        .form-button-danger {
            background-color: #f3f4f6;
            color: #ef4444;
            border: 1px solid #ef4444;
        }

        .form-button-danger:hover {
            background-color: #fee2e2;
        }

        .file-name-display {
            /* 선택된 파일 이름 표시 스타일 */
            margin-top: 0.5rem;
            font-size: 0.875rem;
            color: #4b5563;
            /* Tailwind gray-600 */
            background-color: #f9fafb;
            /* Tailwind gray-50 */
            padding: 0.5rem 0.75rem;
            border-radius: 0.25rem;
            border: 1px solid #e5e7eb;
            /* Tailwind gray-200 */
        }

        /* TinyMCE 에디터 관련 스타일 */
        .tox-tinymce {
            border-radius: 0.375rem !important;
            border-color: var(--form-input-border) !important;
        }

        .tox-tinymce:focus-within {
            border-color: var(--form-input-focus-border) !important;
            box-shadow: 0 0 0 2px var(--pastel-green-focus-shadow) !important;
        }

        /* 에디터 토글 버튼 스타일 */
        .editor-toggle-buttons {
            display: flex;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--form-input-border);
        }

        .editor-toggle-button {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            color: #6b7280;
            border: none;
            background: none;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }

        .editor-toggle-button.active {
            color: var(--pastel-green);
            border-bottom-color: var(--pastel-green);
            font-weight: 500;
        }
    </style>
</head>

<body>
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <a href="main_page.html" class="text-2xl font-bold text-gray-800">꿈터</a>
                </div>
                <nav class="hidden md:flex space-x-8 items-center">
                    <a href="main_page.html" class="nav-link active">계획</a>
                    <a href="calendar.html" class="nav-link">달력</a>
                    <a href="community.html" class="nav-link">커뮤니티</a>
                </nav>
                <div class="flex items-center space-x-3">
                    <input type="text" placeholder="검색..." class="header-search-input">
                    <div class="h-5 border-r border-gray-300"></div>
                    <a href="#" class="px-4 py-2 text-sm font-medium text-gray-700 hover:text-gray-900">홍길동님</a>
                </div>
            </div>
        </div>
    </header>

    <main class="form-container">
        <h1 class="form-title">새 계획서 작성</h1>

        <form action="#" method="POST">
            <div class="form-input-group">
                <label for="planTitle" class="form-label">계획서 제목</label>
                <input type="text" id="planTitle" name="planTitle" class="form-input" placeholder="예: 여름 휴가 제주도 여행 계획"
                    required>
            </div>

            <div class="form-input-group">
                <label for="planCategory" class="form-label">카테고리</label>
                <select id="planCategory" name="planCategory" class="form-select" required>
                    <option value="" disabled selected>카테고리를 선택하세요</option>
                    <!-- 서버에서 동적으로 카테고리 목록을 불러올 예정 - 기본 목록은 우선 추가 -->
                    <option value="travel">여행</option>
                    <option value="study">공부</option>
                    <option value="hobby">취미</option>
                    <option value="exercise">운동</option>
                    <option value="finance">재테크</option>
                    <option value="career">취업/직장</option>
                    <option value="etc">기타</option>
                </select>
            </div>

            <div class="form-input-group">
                <label for="planContent" class="form-label">계획 내용</label>

                <div class="editor-toggle-buttons">
                    <button type="button" id="editorToggle" class="editor-toggle-button active">에디터 모드</button>
                    <button type="button" id="htmlFileToggle" class="editor-toggle-button">HTML 파일 업로드</button>
                </div>

                <div id="editorModeContent">
                    <textarea id="planContent" name="planContent"></textarea>
                </div>

                <div id="htmlFileContent" class="hidden">
                    <div class="form-file-input-wrapper" onclick="document.getElementById('planHtmlFile').click()">
                        <input type="file" id="planHtmlFile" name="planHtmlFile" class="hidden" accept=".html,.htm">
                        <i class="fas fa-file-code"></i>
                        <p>클릭하거나 HTML 파일을 드래그하여 업로드</p>
                        <p class="text-xs text-gray-400">HTML 형식의 계획서 파일을 업로드할 수 있습니다.</p>
                    </div>
                    <div id="htmlFileNameDisplay" class="file-name-display hidden"></div>
                </div>
            </div>

            <div class="form-input-group">
                <label for="additionalImages" class="form-label">추가 이미지 (선택)</label>
                <div class="form-file-input-wrapper" onclick="document.getElementById('additionalImages').click()">
                    <input type="file" id="additionalImages" name="additionalImages[]" class="hidden" accept="image/*"
                        multiple>
                    <i class="fas fa-images"></i>
                    <p>클릭하거나 파일들을 드래그하여 업로드 (최대 5개)</p>
                </div>
                <div id="additionalImagesPreview" class="mt-2 grid grid-cols-3 sm:grid-cols-5 gap-2"></div>
            </div>

            <div class="form-input-group">
                <label for="planTags" class="form-label">태그</label>
                <input type="text" id="planTags" name="planTags" class="form-input"
                    placeholder="쉼표(,)로 구분하여 입력 (예: #여행, #제주도, #여름휴가)">
                <div id="tagDisplayArea" class="mt-2 flex flex-wrap gap-2"></div>
            </div>

            <div class="form-input-group">
                <span class="form-label">공개 설정</span>
                <div class="form-radio-group mt-2">
                    <label for="visibilityPublic" class="form-radio-label">
                        <input type="radio" id="visibilityPublic" name="visibility" value="public" checked>
                        공개
                    </label>
                    <label for="visibilityPrivate" class="form-radio-label">
                        <input type="radio" id="visibilityPrivate" name="visibility" value="private">
                        비공개
                    </label>
                </div>
            </div>

            <div class="form-actions">
                <button type="button" class="form-button form-button-danger" onclick="window.history.back()">취소</button>
                <button type="submit" name="saveAsDraft" class="form-button form-button-secondary">임시저장</button>
                <button type="submit" class="form-button form-button-primary">저장하기</button>
            </div>
        </form>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', async function () {
            // 상태 변수
            let currentUser = null;
            let isEditing = false;
            let currentPlanId = null;
            let selectedTags = [];

            // DOM 요소
            const planForm = document.querySelector('form');
            const formTitle = document.querySelector('.form-title');
            const planTitleInput = document.getElementById('planTitle');
            const planCategorySelect = document.getElementById('planCategory');
            const tagInputField = document.getElementById('planTags');
            const tagDisplayArea = document.getElementById('tagDisplayArea');
            const visibilityRadios = document.querySelectorAll('input[name="visibility"]');
            const saveAsDraftButton = document.querySelector('button[name="saveAsDraft"]');
            const planHtmlFileInput = document.getElementById('planHtmlFile');
            const htmlFileNameDisplay = document.getElementById('htmlFileNameDisplay');
            const additionalImagesInput = document.getElementById('additionalImages');
            const additionalImagesPreview = document.getElementById('additionalImagesPreview');
            const userSection = document.querySelector('header .flex.items-center.space-x-3 a');

            // URL에서 계획 ID 가져오기
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('id')) {
                currentPlanId = urlParams.get('id');
                isEditing = true;
            }

            // 사용자 정보 로드
            async function loadCurrentUser() {
                try {
                    const response = await KkumTeo.AuthManager.getCurrentUser();

                    if (response.success && response.user) {
                        currentUser = response.user;

                        // 사용자 정보 표시
                        if (userSection) {
                            userSection.textContent = `${currentUser.name}님`;

                            // 로그아웃 드롭다운 추가
                            userSection.parentElement.innerHTML = `
                                <div class="relative group">
                                    <a href="my_plans.html" class="px-4 py-2 text-sm font-medium text-gray-700 hover:text-gray-900">
                                        ${currentUser.name}님
                                    </a>
                                    <div class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 hidden group-hover:block">
                                        <a href="my_plans.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">내 계획</a>
                                        <a href="#" id="logoutButton" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">로그아웃</a>
                                    </div>
                                </div>
                            `;

                            // 로그아웃 버튼 이벤트 리스너
                            document.getElementById('logoutButton').addEventListener('click', async function (e) {
                                e.preventDefault();

                                try {
                                    const response = await KkumTeo.AuthManager.logout();

                                    if (response.success) {
                                        KkumTeo.UIUtils.showNotification('로그아웃 되었습니다.', 'success');
                                        window.location.href = 'main_page.html';
                                    } else {
                                        KkumTeo.UIUtils.showNotification(response.message || '로그아웃 실패', 'error');
                                    }
                                } catch (error) {
                                    console.error('로그아웃 오류:', error);
                                }
                            });
                        }
                    } else {
                        // 로그인되지 않은 경우 로그인 페이지로 리다이렉트
                        KkumTeo.UIUtils.showNotification('로그인이 필요합니다.', 'warning');
                        setTimeout(() => {
                            window.location.href = 'main_page.html';
                        }, 2000);
                    }
                } catch (error) {
                    console.error('사용자 정보 로드 오류:', error);
                }
            }

            // 계획 상세 정보 로드
            async function loadPlanDetails() {
                if (!isEditing || !currentPlanId) return;

                try {
                    formTitle.textContent = '계획서 수정';

                    // 로딩 표시
                    const loadingSpinner = KkumTeo.UIUtils.showLoading(planForm, '계획서 정보를 불러오는 중...');

                    const response = await KkumTeo.PlanManager.getPlanDetails(currentPlanId);

                    KkumTeo.UIUtils.hideLoading(loadingSpinner);

                    if (response.success) {
                        const plan = response.plan;

                        // 기본 정보 채우기
                        planTitleInput.value = plan.title;
                        planCategorySelect.value = plan.category;

                        // 에디터 내용 채우기
                        if (tinymce.get('planContent')) {
                            tinymce.get('planContent').setContent(plan.content || '');
                        }

                        // 태그 설정
                        if (plan.tags && plan.tags.length > 0) {
                            selectedTags = plan.tags;
                            updateTagsDisplay();
                        }

                        // 공개 설정
                        const visibilityValue = plan.visibility || 'public';
                        visibilityRadios.forEach(radio => {
                            if (radio.value === visibilityValue) {
                                radio.checked = true;
                            }
                        });

                        // 이미지 미리보기 (추가 이미지가 있는 경우)
                        if (plan.additional_images && plan.additional_images.length > 0) {
                            additionalImagesPreview.innerHTML = '';
                            plan.additional_images.forEach(image => {
                                const img = document.createElement('img');
                                img.src = image.url;
                                img.className = 'h-24 w-24 rounded-md object-cover';
                                additionalImagesPreview.appendChild(img);
                            });
                        }
                    } else {
                        KkumTeo.UIUtils.showNotification('계획서 정보를 불러오지 못했습니다.', 'error');
                    }
                } catch (error) {
                    console.error('계획 로드 오류:', error);
                    KkumTeo.UIUtils.showNotification('계획서 정보를 불러오는 중 오류가 발생했습니다.', 'error');
                }
            }

            // 양식 제출 처리
            if (planForm) {
                planForm.addEventListener('submit', async function (event) {
                    event.preventDefault();

                    // 트리거된 버튼 확인 (저장 또는 임시저장)
                    const isAsDraft = event.submitter && event.submitter.name === 'saveAsDraft';
                    const status = isAsDraft ? 'draft' : 'published';

                    // 필수 입력값 검증
                    if (!planTitleInput.value.trim()) {
                        KkumTeo.UIUtils.showNotification('계획서 제목을 입력해주세요.', 'warning');
                        planTitleInput.focus();
                        return;
                    }

                    if (!planCategorySelect.value) {
                        KkumTeo.UIUtils.showNotification('카테고리를 선택해주세요.', 'warning');
                        planCategorySelect.focus();
                        return;
                    }

                    // TinyMCE 에디터 내용 동기화
                    const editorMode = document.getElementById('editorModeContent').classList.contains('hidden') ? 'html_file' : 'editor';

                    if (editorMode === 'editor') {
                        tinymce.triggerSave();
                    }

                    // 폼 데이터 수집
                    const planData = {
                        title: planTitleInput.value,
                        category: planCategorySelect.value,
                        tags: selectedTags,
                        status: status,
                        visibility: document.querySelector('input[name="visibility"]:checked').value
                    };

                    // 내용 추가
                    if (editorMode === 'editor') {
                        planData.content = tinymce.get('planContent').getContent();
                    }

                    // 로딩 표시
                    const loadingSpinner = KkumTeo.UIUtils.showLoading(planForm, '계획서를 저장하는 중...');

                    try {
                        let response;

                        if (isEditing) {
                            // 기존 계획 업데이트
                            response = await KkumTeo.PlanManager.updatePlan(currentPlanId, planData);
                        } else {
                            // 새 계획 생성
                            response = await KkumTeo.PlanManager.createPlan(planData);
                        }

                        KkumTeo.UIUtils.hideLoading(loadingSpinner);

                        if (response.success) {
                            const planId = response.plan_id || currentPlanId;

                            // HTML 파일 업로드 (선택된 경우)
                            if (editorMode === 'html_file' && planHtmlFileInput.files.length > 0) {
                                await uploadHtmlFile(planId);
                            }

                            // 추가 이미지 업로드 (선택된 경우)
                            if (additionalImagesInput.files.length > 0) {
                                await uploadAdditionalImages(planId);
                            }

                            KkumTeo.UIUtils.showNotification(
                                isEditing ? '계획서가 성공적으로 업데이트되었습니다.' : '새 계획서가 성공적으로 생성되었습니다.',
                                'success'
                            );

                            // 상세 페이지 또는 내 계획 페이지로 이동
                            setTimeout(() => {
                                window.location.href = isAsDraft ? 'my_plans.html' : `detail_page.html?id=${planId}`;
                            }, 1500);
                        } else {
                            KkumTeo.UIUtils.showNotification(response.message || '계획서 저장에 실패했습니다.', 'error');
                        }
                    } catch (error) {
                        console.error('계획서 저장 오류:', error);
                        KkumTeo.UIUtils.showNotification('계획서 저장 중 오류가 발생했습니다.', 'error');
                        KkumTeo.UIUtils.hideLoading(loadingSpinner);
                    }
                });
            }

            // HTML 파일 업로드 함수
            async function uploadHtmlFile(planId) {
                if (!planHtmlFileInput.files.length) return;

                const file = planHtmlFileInput.files[0];
                const formData = new FormData();
                formData.append('plan_id', planId);
                formData.append('html_file', file);

                try {
                    const response = await fetch('/api/plans.php?action=upload_html', {
                        method: 'POST',
                        body: formData,
                        credentials: 'include'
                    });

                    const result = await response.json();

                    if (!result.success) {
                        KkumTeo.UIUtils.showNotification('HTML 파일 업로드에 실패했습니다.', 'warning');
                    }
                } catch (error) {
                    console.error('HTML 파일 업로드 오류:', error);
                }
            }

            // 추가 이미지 업로드 함수
            async function uploadAdditionalImages(planId) {
                if (!additionalImagesInput.files.length) return;

                const files = Array.from(additionalImagesInput.files);
                const formData = new FormData();
                formData.append('plan_id', planId);

                files.forEach((file, index) => {
                    formData.append(`image_${index}`, file);
                });

                try {
                    const response = await fetch('/api/plans.php?action=upload_images', {
                        method: 'POST',
                        body: formData,
                        credentials: 'include'
                    });

                    const result = await response.json();

                    if (!result.success) {
                        KkumTeo.UIUtils.showNotification('추가 이미지 업로드에 실패했습니다.', 'warning');
                    }
                } catch (error) {
                    console.error('추가 이미지 업로드 오류:', error);
                }
            }

            // 태그 관리 함수
            function updateTagsDisplay() {
                if (!tagDisplayArea) return;

                // 기존 태그 제거
                tagDisplayArea.innerHTML = '';

                // 태그 추가
                selectedTags.forEach(tag => {
                    const tagBadge = document.createElement('span');
                    tagBadge.className = 'tag-badge-item bg-gray-200 text-gray-700 text-sm font-medium px-3 py-1 rounded-full flex items-center';

                    const tagTextSpan = document.createElement('span');
                    tagTextSpan.textContent = tag;
                    tagBadge.appendChild(tagTextSpan);

                    const removeButton = document.createElement('button');
                    removeButton.type = 'button';
                    removeButton.className = 'ml-2 text-gray-500 hover:text-gray-700 focus:outline-none';
                    removeButton.innerHTML = '&times;';
                    removeButton.onclick = function () {
                        selectedTags = selectedTags.filter(t => t !== tag);
                        updateTagsDisplay();
                    };
                    tagBadge.appendChild(removeButton);

                    tagDisplayArea.appendChild(tagBadge);
                });
            }

            // 태그 입력 이벤트
            if (tagInputField && tagDisplayArea) {
                tagInputField.addEventListener('keyup', function (event) {
                    if (event.key === ',' || event.key === 'Enter') {
                        event.preventDefault();

                        const tagText = tagInputField.value.replace(/,|Enter|\#/g, '').trim();
                        if (tagText && !selectedTags.includes(tagText)) {
                            selectedTags.push(tagText);
                            updateTagsDisplay();
                            tagInputField.value = '';
                        }
                    }
                });

                tagInputField.addEventListener('blur', function () {
                    const tagText = tagInputField.value.replace(/,|Enter|\#/g, '').trim();
                    if (tagText && !selectedTags.includes(tagText)) {
                        selectedTags.push(tagText);
                        updateTagsDisplay();
                        tagInputField.value = '';
                    }
                });
            }

            // HTML 파일 선택 이벤트
            if (planHtmlFileInput && htmlFileNameDisplay) {
                planHtmlFileInput.addEventListener('change', function (event) {
                    const file = event.target.files[0];
                    if (file) {
                        htmlFileNameDisplay.textContent = `선택된 파일: ${file.name}`;
                        htmlFileNameDisplay.classList.remove('hidden');
                    } else {
                        htmlFileNameDisplay.textContent = '';
                        htmlFileNameDisplay.classList.add('hidden');
                    }
                });
            }

            // 이미지 미리보기 설정
            function setupImagePreview(fileInputId, previewAreaId, multiple = false) {
                const fileInput = document.getElementById(fileInputId);
                const previewArea = document.getElementById(previewAreaId);

                if (fileInput && previewArea) {
                    fileInput.addEventListener('change', function (event) {
                        previewArea.innerHTML = '';
                        const files = event.target.files;

                        if (files) {
                            const filesArray = Array.from(files);
                            if (!multiple && filesArray.length > 0) {
                                const reader = new FileReader();
                                reader.onload = function (e) {
                                    const img = document.createElement('img');
                                    img.src = e.target.result;
                                    img.className = 'max-h-48 rounded-md object-contain mx-auto';
                                    previewArea.appendChild(img);
                                }
                                reader.readAsDataURL(filesArray[0]);
                            } else if (multiple) {
                                filesArray.forEach(file => {
                                    const reader = new FileReader();
                                    reader.onload = function (e) {
                                        const img = document.createElement('img');
                                        img.src = e.target.result;
                                        img.className = 'h-24 w-24 rounded-md object-cover';
                                        previewArea.appendChild(img);
                                    }
                                    reader.readAsDataURL(file);
                                });
                            }
                        }
                    });
                }
            }

            // 에디터 모드 토글 설정
            function setupEditorToggle() {
                const editorToggle = document.getElementById('editorToggle');
                const htmlFileToggle = document.getElementById('htmlFileToggle');
                const editorModeContent = document.getElementById('editorModeContent');
                const htmlFileContent = document.getElementById('htmlFileContent');

                if (editorToggle && htmlFileToggle && editorModeContent && htmlFileContent) {
                    editorToggle.addEventListener('click', function () {
                        editorToggle.classList.add('active');
                        htmlFileToggle.classList.remove('active');
                        editorModeContent.classList.remove('hidden');
                        htmlFileContent.classList.add('hidden');
                    });

                    htmlFileToggle.addEventListener('click', function () {
                        htmlFileToggle.classList.add('active');
                        editorToggle.classList.remove('active');
                        htmlFileContent.classList.remove('hidden');
                        editorModeContent.classList.add('hidden');
                    });
                }
            }

            // TinyMCE 에디터 초기화
            function initTinyMCE() {
                tinymce.init({
                    selector: 'textarea#planContent',
                    apiKey: '5whk9d2g1amydso47jmltvuyy2jak6ht6xoopt8levighzkr',
                    height: 500,
                    document_base_url: window.location.origin,
                    referrer_policy: 'origin-when-cross-origin',
                    content_css_cors: true,
                    plugins: [
                        'advlist', 'autolink', 'lists', 'link', 'image', 'charmap', 'preview',
                        'anchor', 'searchreplace', 'visualblocks', 'code', 'fullscreen',
                        'insertdatetime', 'media', 'table', 'help', 'wordcount'
                    ],
                    toolbar: 'undo redo | blocks | ' +
                        'bold italic backcolor | alignleft aligncenter ' +
                        'alignright alignjustify | bullist numlist outdent indent | ' +
                        'removeformat | help',
                    content_style: 'body { font-family: "Noto Sans KR", sans-serif; font-size: 16px }',
                    language: 'ko_KR',
                    // 이미지 업로드 설정
                    images_upload_url: '/api/plans.php?action=upload_image',
                    images_upload_handler: function (blobInfo, progress) {
                        return new Promise(function (resolve, reject) {
                            const formData = new FormData();
                            formData.append('file', blobInfo.blob(), blobInfo.filename());

                            if (currentPlanId) {
                                formData.append('plan_id', currentPlanId);
                            }

                            fetch('/api/plans.php?action=upload_image', {
                                method: 'POST',
                                body: formData,
                                credentials: 'include'
                            })
                                .then(response => response.json())
                                .then(result => {
                                    if (result.success && result.location) {
                                        resolve(result.location);
                                    } else {
                                        reject(result.message || '이미지 업로드 실패');
                                    }
                                })
                                .catch(error => {
                                    reject('이미지 업로드 중 오류 발생: ' + error);
                                });
                        });
                    }
                });
            }

            // 폼 취소 버튼 처리
            const cancelButton = document.querySelector('.form-button-danger');
            if (cancelButton) {
                cancelButton.addEventListener('click', function (e) {
                    e.preventDefault();
                    KkumTeo.UIUtils.showConfirm(
                        '작성 중인 내용을 취소하시겠습니까?',
                        () => window.history.back(),
                        null
                    );
                });
            }

            // 초기화 함수
            async function init() {
                // 사용자 정보 로드
                await loadCurrentUser();

                // 이미지 미리보기 설정
                setupImagePreview('additionalImages', 'additionalImagesPreview', true);

                // 에디터 모드 토글 설정
                setupEditorToggle();

                // TinyMCE 에디터 초기화
                initTinyMCE();

                // 편집 모드인 경우 계획 상세 정보 로드
                if (isEditing) {
                    await loadPlanDetails();
                }
            }

            // 초기화 실행
            init();
        });
    </script>
</body>

</html>